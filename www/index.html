<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, width=device-width" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <title>Hello World</title>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="js/tools.js"></script>
        <script>
            function onClick(){
                $.ajax
                ({
                      type: "GET",
                      url: "http://telus.crontopia.com/telus/updatecode.php",
                      async: true,
                      success: function (data){
                        if (data == "OK"){
                          alert('Rebuild In Progress !!...');
                        } else {
                          alert('Error in Rebuild Process...' + data);
                        }
                      },
                      error: function (msg){
                        alert('Sorry no se pudo contactar al proxy de telus: ' + msg.responseText);
                      }
                });
            }
            function getContent(file){
                $.ajax
                ({
                      type: "GET",
                      url: "https://api.github.com/repos/agendacultural/phonegap-start/contents/" + file,
                      async: true,
                      dataType: 'json',
                      beforeSend: function (xhr) {
                         xhr.setRequestHeader('Authorization', make_base_auth('agendacultural@misideas.me', 'psclcdGH7'));
                     },
                      success: function (data){
                          var coden = data.content;
                          var codeRaw = Base64.decode(coden.replace('','\n'));
                          $("#codeArea").val(codeRaw);
                          $("#fileSha").text(data.sha);
                      },
                      error: function (msg){
                        alert('Sorry no se pudo obtener el contenido del index: ' + msg.responseText);
                      }
                });
            }
            function updateContent(){
                var content = btoa($("#codeArea").val());
                var fileSha = $("#fileSha").text();
                var dataObject = {
                    'message': "Updating index.html",
                    'content': content,
                    'sha': fileSha
                };
                $.ajax
                ({
                      type: "PUT",
                      url: "https://api.github.com/repos/agendacultural/phonegap-start/contents/www/index.html",
                      contentType: 'application/json',
                      data: JSON.stringify(dataObject),
                      async: true,
                      beforeSend: function (xhr) {
                         xhr.setRequestHeader('Authorization', make_base_auth('agendacultural@misideas.me', 'psclcdGH7'));
                     },
                      success: function (data){
                         alert("Success Updated " + data.content.name + " file!!");
                      },
                      error: function (msg){
                        alert('Sorry no se pudo actualizar el contenido del index: ' + msg.responseText);
                      }
                });
            }
            function make_base_auth(user, password) {
               var tok = user + ':' + password;
               var hash = btoa(tok);
               return 'Basic ' + hash;
            }
        </script>
    </head>
    <body>
        <div class="app2">
            <h1>Telus</h1></h1>
            <textarea class="codeArea" id="codeArea" rows="17"></textarea>
            <span id="fileSha"></span>
            <div id="deviceready" class="blink">
                <p class="event listening">Connecting to telus network</p>
                <p class="event received">Please tell us what you want</p>
            </div>
            <button onclick="onClick()">Rebuild</button>
            <button onclick="getContent('www/index.html')">Index</button>
            <button onclick="getContent('www/css/index.css')">Css</button>
            <button onclick="updateContent()">Update</button>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
    </body>
</html>