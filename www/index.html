<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, width=device-width" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <title>Hello World</title>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="js/tools.js"></script>
        <script>
            function onClick(){
                $.ajax
                ({
                      type: "GET",
                      url: "http://telus.crontopia.com/telus/updatecode.php",
                      async: true,
                      success: function (data){
                        if (data == "OK"){
                          alert('Rebuild In Progress !!...');
                        } else {
                          alert('Error in Rebuild Process...' + data);
                        }
                      },
                      error: function (msg){
                        alert('Sorry no se pudo contactar al proxy de telus: ' + msg.responseText);
                      }
                });
            }
            function getContent(path){
                 
                $.ajax
                ({
                      type: "GET",
                      url: "https://api.github.com/repos/agendacultural/phonegap-start/contents/" + path,
                      async: true,
                      dataType: 'json',
                      beforeSend: function (xhr) {
                         xhr.setRequestHeader('Authorization', make_base_auth('agendacultural@misideas.me', 'psclcdGH7'));
                     },
                      success: function (data){
                          var coden = data.content;
                          var codeRaw = Base64.decode(coden.replace('','\n'));
                          $("#codeArea").val(codeRaw);
                          $("#fileSha").text(data.sha);
                          $("#filePath").text(data.path);
                          
                      },
                      error: function (msg){
                        alert('Sorry no se pudo obtener el contenido del index: ' + msg.responseText);
                      }
                });
            }
            function updateContent(){
                var content = btoa($("#codeArea").val());
                var fileSha = $("#fileSha").text();
                var filePath = $("#filePath").text();
                var msg = "Updating " + filePath;
                var dataObject = {
                    'message': msg,
                    'content': content,
                    'sha': fileSha
                };
                $.ajax
                ({
                      type: "PUT",
                      url: "https://api.github.com/repos/agendacultural/phonegap-start/contents/" + filePath,
                      contentType: 'application/json',
                      data: JSON.stringify(dataObject),
                      async: true,
                      beforeSend: function (xhr) {
                         xhr.setRequestHeader('Authorization', make_base_auth('agendacultural@misideas.me', 'psclcdGH7'));
                     },
                      success: function (data){
                         $("#fileSha").text(data.content.sha);
                         alert("Successfull Updated " + data.content.name );
                      },
                      error: function (msg){
                        alert('Sorry no se pudo actualizar el contenido del index: ' + msg.responseText);
                      }
                });
            }
            function make_base_auth(user, password) {
               var tok = user + ':' + password;
               var hash = btoa(tok);
               return 'Basic ' + hash;
            }
            function onPreview(){
                var ref = window.open('http://telus.crontopia.com/website/www/', '_blank', 'location=no');
                ref.addEventListener('loadstart', function() { alert(event.url); });
            }

            $('#frmImport').submit(function(e){
             e.preventDefault();
              //CHECK ERRORS ON USER SIDE, IF TRUE, END OPERATIONS.
              if (import_errors()){
                 return false;
              }
              import_db();
              return false;
           });

          function import_errors(){
            if ($('#fileImportData').val() == ''){
              alert('No file(s) selected. Please choose a image file to upload.');
              return true;
            }
            if ($('#fileImportData').val() != ''){
              var ext = $('#fileImportData').val().split('.').pop().toLowerCase();
              if($.inArray(ext, ['jpeg','jpg','png']) == -1) {
                alert('Invalid file type. Please choose a Image file to upload.');
                return true;
              }
            }
            return false;
         }

         function import_db(){
              var formData = new FormData();
              var imageFile = $('#fileImportData')[0].files[0];
              var msg = 'New image uploaded';
              var content = btoa(imageFile);
              var dataObject = {
                    'message': msg,
                    'content': content
              };
              $.ajax
                ({
                      type: "PUT",
                      url: "https://api.github.com/repos/agendacultural/phonegap-start/contents/www/img/prima.jpg",
                      contentType: 'application/json',
                      data: JSON.stringify(dataObject),
                      async: true,
                      beforeSend: function (xhr) {
                         xhr.setRequestHeader('Authorization', make_base_auth('agendacultural@misideas.me', 'psclcdGH7'));
                     },
                      success: function (data){
                         $("#fileSha").text(data.content.sha);
                         alert("Successful Upload Image " + data.content.name );
                      },
                      error: function (msg){
                        alert('Sorry no se pudo subir la imagen: ' + msg.responseText);
                      }
                });
        }

        function goEdit(){
         if ($("#editBtn").html() == "Edit"){
          $("#editPanel").css ("display","block");
          $("#editBtn").html("Run");
         } else {
          $("#editPanel").css ("display","none");
          $("#editBtn").html("Edit");
         }
        }
        </script>
    </head>
    <body>
        <div class="app2">
            <h1>Telus what you want<button id="editBtn" onclick="goEdit ()">Edit</button></h1>
            <div id="deviceready" class="blink">
                <p class="event listening">NO CONNECTED TO DEVICE</p>
                <p class="event received">DEVICE READY</p>
            </div>
            <div id="editPanel" class="editPanel">
             <button onclick="getContent('www/index.html')">HTML</button>
             <button onclick="getContent('www/css/index.css')">CSS</button>
             <button onclick="getContent('www/js/index.js')">JS</button>
             <button onclick="getContent('www/config.xml')">Config</button><br/>
             <button onclick="updateContent()">Update</button>
             <button onclick="onClick()">Rebuild</button>
             <button onclick="onPreview()">Preview</button><br/>
             <span id="filePath"></span><br/>
             <span id="fileSha"></span><br/>
             <textarea class="codeArea" id="codeArea" rows="17"></textarea><br/>
            </div>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
    </body>
</html>